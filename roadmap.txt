Roadmap: SerialLCD Daemon (sibling program sends data over UART)

Mission
- Single Rust daemon that listens on UART for structured messages from the sibling program and renders them on a 16x2 HD44780 (PCF8574 I2C backpack). No network, no extra interfaces.

Main Settings
- Backlight policy is always on unless disabled by payload oo blink on alert.
- 16x2 LCD (configurable via config file).
- UART: /dev/ttyAMA0, 115200 8N1 (configurable via config file).
- I2C: PCF8574 at 0x27 (configurable via config file).

Input protocol (from sibling)
- Transport: UART (/dev/ttyAMA0 by default), 115200 8N1.
- Message framing: newline-delimited UTF-8 text.
- Payload options:
  - JSON: e.g., {"line1":"...", "line2":"..."}
  - key=value lists: e.g., line1=Hello;line2=World;backlight=1
- TODO: finalize one format (prefer newline JSON for extensibility) and reject malformed frames with error logging.
- TODO: define maximum line length and truncate safely (16 or 20 columns).
- TODO: define custom icon indices 0-7 to map to CGRAM slots preloaded at startup.
- Metrics payloads (from sibling): uptime, free RAM, CPU %, disk %, temperature. Include normalized percentages to drive bar graphs.
- Simple payload schema ideas (pick a small subset to support):
  - Fields: `line1`, `line2` (plain text), `backlight` (optional; only send when false to turn off), `blink` (0/1 for backlight blink on error), `scroll_speed_ms` (optional; default from config), `bar` (percent, defaults to 0–100) or `bar_value` + optional `bar_max` (default 100).
  - Commands: `clear=1`, `test=1` (writes “TEST”), `heartbeat=1` (optional ping to keep display alive), `priority` (0–9) to avoid lower-priority updates overwriting active alerts.
  - Alerts: `alert=1` sets backlight blink and prefixes “ALERT:” on line 1; `alert_msg` overrides line 2.
  - Duration: `ttl_ms` to keep a message on screen before it expires (else stickiness until next frame).
  - Modes: `mode=dashboard|scroll|banner` (dashboard = summary + bar; scroll = marquee long text; banner = single line scrolling).
  - Truncation: if `scroll=0` and text exceeds columns, truncate with ellipsis; if `scroll=1`, auto marquee.
  - Bar graph: `bar_label` to show short label on line 1 (e.g., “CPU 42%”), with `bar` on line 2.
  - Auto-scroll: if a line exceeds width, auto-scroll with a default speed (e.g., 250 ms step); `scroll_speed_ms` can override. No mode flag required for scrolling.
  - Bar scaling: accept `bar_value` and optional `bar_max` (default 100). Compute percent = min(bar_value/bar_max*100, 100) to render bar automatically (e.g., `bar_value=500`, `bar_max=1000` → 50%).
- Protocol hygiene:
  - Max frame size (e.g., 512 bytes); drop oversized frames.
  - Optional version tag; unknown versions log + drop if provided.
  - Optional checksum/hash field (CRC32 hex recommended) to detect stale/changed payloads; if present and invalid, drop frame.
  - Newline required terminator; ignore partial frames without newline.

Serial handling
- Blocking or async: start with blocking `serialport`; optionally add `tokio-serial` under `async-serial` feature.
- TODO: add reconnection/backoff if the device disappears.
- TODO: add basic framing validator (newline required; drop overlong frames).
- TODO: log parse errors to stderr (or RAM disk if logging file is needed).

LCD handling
- Use `lcd_driver::Hd44780` over PCF8574 (with optional autodetect).
- TODO: expose a lightweight API to set two lines and backlight state atomically to reduce flicker.
- TODO: bar graphs: precompute 0-5 block chars (0%, 20%, 40%, 60%, 80%, 100%) and a helper `render_bar(percent, width)` to render usage bars (CPU/memory/disk).
- TODO: status dashboard layout: line 1 = text summary (e.g., "Up 12:34  CPU 23%"), line 2 = bar graph for key metric.
- CGRAM reservation: document slots 0–5 for bar blocks, 6 for heartbeat, 7 free for sibling payloads; enforce no overwrite unless explicitly allowed.
  - Auto-scroll behavior: default marquee for any line longer than width; allow per-frame `scroll_speed_ms` to override default speed.
- TODO: physical button hook: register a GPIO push-button to advance to the next “page” of stored frames; debounce input and ignore during active alerts unless configured otherwise.

Config
- Persistent: `~/.serial_lcd/config.toml` (already implemented).
- Fields: `device`, `baud`, `cols`, `rows`, optional `pcf8574_addr`, `scroll_speed_ms` default, `page_timeout_ms` default, optional `button_gpio_pin`.
- TODO: allow `pcf8574_addr = "auto"` to trigger autodetect.
- TODO: runtime flag to override config (`--device`, `--baud`, etc.) remains the highest priority.
- Hot reload/overrides: optionally watch config file or accept `config` commands in payload to update scroll speed/backlight policy; log applied changes.

Daemon loop
- TODO: main loop: read frame -> parse -> map to `line1`, `line2`, backlight hints -> render.
- TODO: rate-limit redraws to avoid flicker (e.g., debounce duplicate frames).
- TODO: handle backlight toggle without disturbing data lines (driver already supports this).
- TODO: optional heartbeat: periodically write a small indicator (custom char) to show liveness.
- Update policy:
  - Rate-limit screen updates (target ~500 ms cadence for fast-moving metrics like CPU; cap minimum to avoid flicker, e.g., 200 ms).
  - De-dup identical payloads to avoid redundant writes.
  - TTL: expire frames after their TTL if provided.
  - Default page timeout: if streaming frames include multiple pages, auto-advance after a default timeout (e.g., 3–5 seconds); allow override via config/payload (`page_timeout_ms`).

Testing/Validation
- Unit tests: already cover driver behaviors; add parser tests for the chosen protocol.
- Integration test: feed sample frames into a mock serial source and assert LCD calls (mock bus).
- TODO: smoke test: init display, write two lines, toggle backlight via the daemon entry point.
- Testing hooks: support `test=1` payload to render a known pattern; add sample frames for alerts, bars, scrolling, and checksum/invalid cases.

API surface for sibling program
- Agreed contract: newline-delimited frames; define required keys (`line1`, `line2`) and optional keys (`backlight`, `clear`).
- TODO: versioning: include a `v` field or prefix to allow future changes (e.g., `v=1;line1=...`).
- Error/diagnostics display: reserve an error state (`ERR PARSE`) and set backlight blink on parse/validation failures; heartbeat icon shows if daemon is alive even when no frames arrive.

Low priority / parking lot
- Custom icons and `{0xNN}` placeholders; define CGRAM slots and preloaded bitmaps once core features are stable.

Operational concerns
- Logs to stderr or `/run/serial_lcd_cache/seriallcd.log` (RAM disk only).
- Ensure graceful shutdown: clear display or show “offline” if desired (configurable).
- Systemd: keep existing unit; ensure service user has access to UART/I2C devices.

Open questions (fill before implementing)
- Exact message format choice (JSON vs key=value).
- Refresh cadence and duplicate-frame suppression policy.
- Backlight policy (always on vs controlled by payload).
